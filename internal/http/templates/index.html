<html>
<head>
	<title>yt-transcribe</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/static/style.css">
	<link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
	<link rel="manifest" href="/static/site.webmanifest">
</head>
<body>
	<a href="/"><img src="/static/logo.webp" alt="yt-transcript" width="180" /></a>
	<p>Enter a YouTube URL to transcribe the video.</p>
	<form method="POST" action="/">
		<input type="text" name="youtube_url" placeholder="Enter YouTube URL" size="50">
		<input type="submit" value="Transcribe">
	</form>

	{{if .ErrorDetail}}
		<p style="color: red;">Error: {{.ErrorDetail}}</p>
	{{end}}

	<h3>Transcriptions</h3>
	<div id="transcriptionQueue">
		<p>Loading transcriptions...</p>
	</div>
	
	<script src="/static/app.js"></script>
	<script>
		let currentQueueData = [];

		function renderQueueTable(queueData) {
			const queueDiv = document.getElementById('transcriptionQueue');
			if (!queueDiv) return;

			if (!queueData || queueData.length === 0) {
				queueDiv.innerHTML = '<p>The queue is currently empty.</p>';
				return;
			}

			let tableHTML = `
				<table>
					<thead>
						<tr>
							<th>Title</th>
							<th>Duration</th>
							<th>Uploaded</th>
							<th>Status</th>
						</tr>
					</thead>
					<tbody id="queueTableBody">
			`;

			queueData.forEach(item => {
				const badge = renderStatusBadge(item.Status);
				tableHTML += `
					<tr onclick="window.location.href='/entry/${escapeHTML(item.VideoID)}';" style="cursor: pointer;">
						<td data-label="Title">${escapeHTML(item.Title)}</td>
						<td data-label="Duration">${escapeHTML(item.Duration)}</td>
						<td data-label="Uploaded">${escapeHTML(window.formatUploadDate(item.UploadDate))}</td>
						<td data-label="Status">${badge}</td>
					</tr>
				`;
			});
			tableHTML += `</tbody></table>`;
			queueDiv.innerHTML = tableHTML;
		}
		
		function escapeHTML(str) {
			if (str === null || str === undefined) {
				return '';
			}
			const p = document.createElement('p');
			p.appendChild(document.createTextNode(str));
			return p.innerHTML;
		}

		async function fetchQueueData() {
			try {
				const response = await fetch('/queue');
				if (!response.ok) {
					console.error('Failed to fetch queue data, status:', response.status);
					const queueDiv = document.getElementById('transcriptionQueue');
					if (queueDiv) {
						queueDiv.innerHTML = '<p>Error loading queue data. Server responded with status ' + response.status + '</p>';
					}
					return;
				}
				currentQueueData = await response.json(); // Store data globally
				renderQueueTable(currentQueueData);
			} catch (error) {
				console.error('Error fetching or parsing queue data:', error);
				currentQueueData = []; // Clear data on error
				const queueDiv = document.getElementById('transcriptionQueue');
				if (queueDiv) {
					queueDiv.innerHTML = '<p>Error loading queue data. Check console for details.</p>';
				}
			}
		}

		// Initial fetch
		fetchQueueData();

		// Refresh on an interval
		setInterval(fetchQueueData, 5000); // Refresh every 5 seconds
	</script>
</body>
</html>
